{% extends 'staffweb/plantilla.html' %}
{% load static %}

{% block head %}
<!-- STATIC CSS -->
<link rel="stylesheet" href="{% static 'staffweb/css/inicio_dashboard.css' %}">
<title>Dashboard</title>
{% endblock head %}

{% block principal %}

<div class="header">
    <h1>Dashboard</h1>
    <p>¡Revisa aquí que la actividad de ManaStaff!</p>
    
</div>

<div class="dashboard-cards">
  <div class="card">
    <h3>Solicitudes Totales</h3>
    <p>{{ total_solicitudes }}</p>
  </div>
  <div class="card">
    <h3>Documentos Disponibles</h3>
    <p>{{ documentos_disponibles }}</p>
  </div>
  <div class="card">
    <h3>Usuarios esta Semana</h3>
    <p>{{ usuarios_regulares_semana_actual }}</p>
  </div>
  <div class="card">
    <h3>Tiempo Promedio de Respuesta</h3>
    <p>{{ promedio_respuesta }} días</p>
  </div>
</div>

<div class="dashboard">

      <!-- Solicitudes por estado -->
      <div class="card">
        <h3>Solicitudes por Estado</h3>
        <canvas id="statusChart"></canvas>
      </div>

      <!-- Tiempo de respuesta -->
      <div class="card">
        <h3>Tiempo de Respuesta Promedio</h3>
        <canvas id="responseTimeChart"></canvas>
      </div>

      <!-- Documentos disponibles -->
      <div class="card">
        <h3>Documentos Cargados por Mes</h3>
        <canvas id="documentsChart"></canvas>
      </div>

      <!-- Tipo de solicitudes -->
      <div class="card">
        <h3>Tipo de Solicitudes</h3>
        <canvas id="typeChart"></canvas>
      </div>

      <!-- Usuarios con más solicitudes -->
      <div class="card">
        <h3>Usuarios con Más Solicitudes</h3>
        <table class="user-table">
          <thead>
            <tr>
              <th>Usuario</th>
              <th>Solicitudes</th>
            </tr>
          </thead>
          <tbody>
            {% for u in top_usuarios %}
              <tr><td>{{ u.nombre }}</td><td>{{ u.total }}</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Tasa de aprobación / rechazo en el tiempo -->
      <div class="card">
        <h3>Tasa Aprobación / Rechazo</h3>
        <canvas id="approvalRateChart"></canvas>
      </div>
      
    </div>

  </div>
{% endblock principal %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'staffweb/js/inicio_dashboard.js' %}"></script>
<script>
const solicitudesEstado = {{ solicitudes_estado|safe }};
const promedioRespuesta = {{ promedio_respuesta }};
const documentosPorMes = {{ documentos_por_mes|safe }};
const tiposSolicitudes = {{ tipos_solicitudes|safe }};
const aprobadasPorMes = {{ aprobadas_por_mes|safe }};
const rechazadasPorMes = {{ rechazadas_por_mes|safe }};

// === Solicitudes por estado ===
new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: {
        labels: ['Pendientes', 'Aprobadas', 'Rechazadas'],
        datasets: [{
            data: solicitudesEstado,
            backgroundColor: ['#f6c23e','#1cc88a','#e74a3b']
        }]
    }
});

// === Tiempo de respuesta ===
new Chart(document.getElementById('responseTimeChart'), {
    type: 'bar',
    data: {
        labels: ['Promedio'],
        datasets: [{
            label: 'Días promedio',
            data: [promedioRespuesta],
            backgroundColor: '#36b9cc'
        }]
    }
});

// === Documentos por mes ===
new Chart(document.getElementById('documentsChart'), {
    type: 'bar',
    data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [{
            label: 'Documentos',
            data: documentosPorMes,
            backgroundColor: '#4e73df'
        }]
    }
});

// === Tipos de solicitudes ===
new Chart(document.getElementById('typeChart'), {
    type: 'bar',
    data: {
        labels: Object.keys(tiposSolicitudes),
        datasets: [{
            data: Object.values(tiposSolicitudes),
            backgroundColor: ['#722fcaff','#27e5dcff','#ebbd34ff','#3477ebff','#277bc1ff']
        }]
    },
    options: { plugins: { legend: { display: false } } }
});

new Chart(document.getElementById('approvalRateChart'), {
    type: 'line',
    data: {
        labels: ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'],
        datasets: [
            {
                label: 'Aprobadas',
                data: aprobadasPorMes,
                borderColor: '#1cc88a',
                fill: false
            },
            {
                label: 'Rechazadas',
                data: rechazadasPorMes,
                borderColor: '#e74a3b',
                fill: false
            }
        ]
    }
});

</script>
{% endblock js %}
