{% extends 'staffweb/plantilla.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'staffweb/css/auditoria.css' %}">
<title>Auditoría del Sistema</title>
{% endblock head %}

{% block principal %}
<div class="header">
    <h1>Administrar logs</h1>
    <p>¡Aquí puedes ver toda la actividad de ManaStaff!</p>
</div>



<div class="dashboard-cards">
  <div class="card">
    <h3>Total de Acciones</h3>
    <p>{{ total_acciones }}</p>
  </div>
  <div class="card">
    <h3>Descargas de Documentos</h3>
    <p>{{ total_descargas }}</p>
  </div>
  <div class="card">
    <h3>Usuarios Activos Hoy</h3>
    <p>{{ usuarios_activos_hoy }}</p>
  </div>
</div>

<div class="dashboard">
  <div class="card">
    <h3>Actividades por Tipo</h3>
    <canvas id="actividades_por_tipo"></canvas>
  </div>

  <div class="card">
    <h3>Actividades por Día (Últimos 7 días)</h3>
    <canvas id="actividades_por_dia"></canvas>
  </div>

  <div class="card">
    <h3>Usuarios Más Activos</h3>
    <table class="user-table">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in top_usuarios_activos %}
          <tr>
            <td>{{ u.nombre }}</td>
            <td><span class="badge badge-{{ u.rol }}">{{ u.rol }}</span></td>
            <td>{{ u.total_acciones }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card" style="grid-column: 1 / -1;">
    <h3>Filtros de Búsqueda</h3>
    <form method="GET" class="filtros-auditoria" id="form-filtros">
      <div class="filtro-grupo">
        <label for="tipo_accion">Tipo de Acción:</label>
        <select name="tipo_accion" id="tipo_accion">
          <option value="">Todas</option>
          {% for aud in tipos_auditoria_lista %}
            <option value="{{ aud.id_tipo }}">{{ aud.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="usuario">Usuario:</label>
        <select name="usuario" id="usuario">
          <option value="">Todos</option>
          {% for u in usuarios_lista %}
            <option value="{{ u.id  }}">{{ u.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="fecha_inicio">Fecha Inicio:</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ fecha_inicio }}">
      </div>
      
      <div class="filtro-grupo">
        <label for="fecha_fin">Fecha Fin:</label>
        <input type="date" name="fecha_fin" id="fecha_fin" value="{{ fecha_fin }}">
      </div>
      
      <button type="submit" class="btn-filtrar">Filtrar</button>
      <button type="button" class="btn-limpiar" id="btnLimpiar">Limpiar</button>
    </form>
  </div>
  
  <div class="card" style="grid-column: 1 / -1;">
    <h3>Registro de Auditoría Detallado</h3>
    <div class="tabla-auditoria-container">
      <table class="user-table tabla-auditoria" id="tablaLogs">
        <thead>
          <tr>
            <th>Fecha y Hora</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Tipo de Acción</th>
            <th>Descripción</th>
            <th>IP</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody id="tablaLogsBody">
          <tr><td colspan="7" style="text-align: center; display: inline-block;">Cargando...</td></tr>
        </tbody>
      </table>
    </div>
    <div class="text-center">
      <button id="btnCargarMas" class="btn-filtrar">Cargar más</button>
    </div>
  </div>

</div>


<div id="modalDetalles" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">&times;</span>
    <h3>Detalles de la Acción</h3>
    <div id="contenidoDetalles"></div>
  </div>
</div>

<!-- Overlay de carga -->
<div id="loadingOverlay">
    <div class="spinner_grande"></div>
</div>

{% endblock principal %}

{% block js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // === Variables del contexto Django ===
  const actividadesPorTipo = {{ actividades_por_tipo|safe }};
  const actividadesPorDia = {{ actividades_por_dia|safe }};
</script>
<script src="{% static 'staffweb/js/auditoria.js' %}"></script>
{% endblock js %}