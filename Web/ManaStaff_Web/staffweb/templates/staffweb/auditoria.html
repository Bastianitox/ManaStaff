{% extends 'staffweb/plantilla.html' %}
{% load static %}

{% block head %}
 STATIC CSS 
<link rel="stylesheet" href="{% static 'staffweb/css/auditoria.css' %}">
<script src="{% static 'staffweb/js/auditoria.js' %}"></script>
<title>Auditoría del Sistema</title>
{% endblock head %}


<div class="header">
    <h1>Auditoría del Sistema</h1>
    <p>Registro completo de actividades de usuarios y administradores</p>
</div>

 Cards de métricas rápidas 
<div class="dashboard-cards">
  <div class="card">
    <h3>Total de Acciones</h3>
    <p>{{ total_acciones }}</p>
  </div>
  <div class="card">
    <h3>Descargas de Documentos</h3>
    <p>{{ total_descargas }}</p>
  </div>
  <div class="card">
    <h3>Cambios Administrativos</h3>
    <p>{{ total_cambios_admin }}</p>
  </div>
  <div class="card">
    <h3>Usuarios Activos Hoy</h3>
    <p>{{ usuarios_activos_hoy }}</p>
  </div>
</div>

<div class="dashboard">

    Filtros de auditoría 
  <div class="card" style="grid-column: 1 / -1;">
    <h3>Filtros de Búsqueda</h3>
    <form method="GET" class="filtros-auditoria">
      <div class="filtro-grupo">
        <label for="tipo_accion">Tipo de Acción:</label>
        <select name="tipo_accion" id="tipo_accion">
          <option value="">Todas</option>
          <option value="descarga">Descarga de Documento</option>
          <option value="cambio">Cambio Administrativo</option>
          <option value="acceso">Acceso a Página</option>
          <option value="creacion">Creación de Registro</option>
          <option value="eliminacion">Eliminación de Registro</option>
          <option value="actualizacion">Actualización de Registro</option>
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="usuario">Usuario:</label>
        <select name="usuario" id="usuario">
          <option value="">Todos</option>
          {% for u in usuarios_lista %}
            <option value="{{ u.id }}">{{ u.nombre }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="filtro-grupo">
        <label for="fecha_inicio">Fecha Inicio:</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio" value="{{ fecha_inicio }}">
      </div>
      
      <div class="filtro-grupo">
        <label for="fecha_fin">Fecha Fin:</label>
        <input type="date" name="fecha_fin" id="fecha_fin" value="{{ fecha_fin }}">
      </div>
      
      <button type="submit" class="btn-filtrar">Filtrar</button>
      <a href="{% url 'auditoria' %}" class="btn-limpiar">Limpiar</a>
    </form>
  </div>

   Gráfico de actividades por tipo 
  <div class="card">
    <h3>Actividades por Tipo</h3>
    <canvas id="actividades_por_tipo"></canvas>
  </div>

   Gráfico de actividades en el tiempo 
  <div class="card">
    <h3>Actividades por Día (Últimos 7 días)</h3>
    <canvas id="actividades_por_dia"></canvas>
  </div>

   Top usuarios más activos 
  <div class="card">
    <h3>Usuarios Más Activos</h3>
    <table class="user-table">
      <thead>
        <tr>
          <th>Usuario</th>
          <th>Rol</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in top_usuarios_activos %}
          <tr>
            <td>{{ u.nombre }}</td>
            <td><span class="badge badge-{{ u.rol }}">{{ u.rol }}</span></td>
            <td>{{ u.total_acciones }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

   Descargas por documento 
  <div class="card">
    <h3>Documentos Más Descargados</h3>
    <canvas id="descargas_por_documento"></canvas>
  </div>

   Tabla de auditoría detallada 
  <div class="card" style="grid-column: 1 / -1;">
    <h3>Registro de Auditoría Detallado</h3>
    <div class="tabla-auditoria-container">
      <table class="user-table tabla-auditoria">
        <thead>
          <tr>
            <th>Fecha y Hora</th>
            <th>Usuario</th>
            <th>Rol</th>
            <th>Tipo de Acción</th>
            <th>Descripción</th>
            <th>IP</th>
            <th>Detalles</th>
          </tr>
        </thead>
        <tbody>
          {% for log in logs_auditoria %}
            <tr>
              <td>{{ log.fecha_hora|date:"d/m/Y H:i:s" }}</td>
              <td>{{ log.usuario.nombre }}</td>
              <td><span class="badge badge-{{ log.usuario.rol }}">{{ log.usuario.rol }}</span></td>
              <td><span class="tipo-accion tipo-{{ log.tipo_accion }}">{{ log.tipo_accion_display }}</span></td>
              <td>{{ log.descripcion }}</td>
              <td>{{ log.ip_address }}</td>
              <td>
                <button class="btn-ver-detalles" onclick="verDetalles({{ log.id }})">Ver</button>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" style="text-align: center;">No hay registros de auditoría</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
     Paginación 
    {% if logs_auditoria.has_other_pages %}
      <div class="paginacion">
        {% if logs_auditoria.has_previous %}
          <a href="?page={{ logs_auditoria.previous_page_number }}" class="btn-paginacion">Anterior</a>
        {% endif %}
        
        <span class="pagina-actual">Página {{ logs_auditoria.number }} de {{ logs_auditoria.paginator.num_pages }}</span>
        
        {% if logs_auditoria.has_next %}
          <a href="?page={{ logs_auditoria.next_page_number }}" class="btn-paginacion">Siguiente</a>
        {% endif %}
      </div>
    {% endif %}
  </div>

</div>

 Modal para detalles 
<div id="modalDetalles" class="modal">
  <div class="modal-content">
    <span class="close" onclick="cerrarModal()">&times;</span>
    <h3>Detalles de la Acción</h3>
    <div id="contenidoDetalles"></div>
  </div>
</div>

{% endblock principal %}