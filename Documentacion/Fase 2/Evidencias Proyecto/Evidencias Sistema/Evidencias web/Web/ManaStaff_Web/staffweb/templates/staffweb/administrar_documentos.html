{% extends 'staffweb/plantilla.html' %}
{% load static %}

{% block head %}
<link rel="stylesheet" href="{% static 'staffweb/css/administrar_documentos.css' %}">
<title>Administrar documentos</title>
{% endblock head %}

{% block principal %}
<div class="header">
  <h1>Administrar Documentos</h1>
  <p>Gestiona los documentos de los usuarios</p>
</div>

<div class="search-filter-section">
  <div class="search-container">
    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none"
         viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
    <input type="text" class="search-input" placeholder="Busca por nombre de usuario..." id="searchInput">
  </div>
</div>

<div class="status-tabs">
    <button class="status-tab" data-status="todos">Todos</button>
    <button class="status-tab" data-status="activo">Activos</button>
    <button class="status-tab" data-status="pendiente">Pendientes</button>
    <button class="status-tab" data-status="caducado">Caducados</button>
</div>

<div class="documents-section">
  <div class="section-header">
    <h2>Documentos por Usuario</h2>
    <a href="{% url 'crear_documento' %}" class="btn-create-document" style="text-decoration: none;">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
        stroke="currentColor" width="20" height="20">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 4v16m8-8H4"/>
        </svg>
        Crear Documento
    </a>
  </div>
  <div id="usersContainer"></div>
</div>

<script id="users-docs-data" type="application/json">
  {{ users_docs_json|default:"[]"|safe }}
</script>

<script>
  window.ROUTES = {
    documentosUsuarios: "{% url 'documentos_usuarios' %}",
    crearDocumento: "{% url 'crear_documento' %}",
    modificarDocumento: "{% url 'modificar_documento' 'DOC_ID' %}",
    eliminarDocumento: "{% url 'eliminar_documento' %}",
  };
</script>

<script>
  const goDocsUsuario = (rut) => {
    const limpio = String(rut).replace(/[^\dkK]/g, "");
    window.location.href = `${window.ROUTES.documentosUsuarios}?rut=${encodeURIComponent(limpio)}`;
  };
</script>

<!-- Modal CONFIRMAR ELIMINACIÓN -->
<div id="deleteModal" class="modal hidden">
  <div class="modal-content" style="max-width:400px">
    <h3 class="delete-title">Eliminar documento</h3>
    <p>¿Eliminar este documento definitivamente?</p>
    <div class="modal-actions modal-actions-center">
      <button id="deleteCancelBtn" class="cancel-modal-btn">Cancelar</button>
      <button id="deleteConfirmBtn" class="confirm-delete-btn">Eliminar</button>
    </div>
  </div>

  <!-- overlay spinner -->
  <div id="loadingSpinner" class="hidden">
    <div class="spinner"></div>
  </div>
</div>

{% if messages %}
  {% for message in messages %}
    <div id="djangoMessageAlert_{{ forloop.counter }}"
    class="alert {% if message.tags == 'error' %}error{% else %}success{% endif %}"
    style="display:flex;">
      <div class="alert-icon">
        {% if message.tags == 'error' %}✕{% else %}✓{% endif %}
      </div>
      <span>{{ message }}</span>

      <script>
        setTimeout(function() {
          var alertEl = document.getElementById("djangoMessageAlert_{{ forloop.counter }}");
          if (alertEl) {
            alertEl.style.transition = "opacity 0.5s ease";
            alertEl.style.opacity = "0";
            setTimeout(() => alertEl.style.display = "none", 500);
          }
        }, 5000);
      </script>
    </div>
  {% endfor %}
{% endif %}

<!-- Alertas centradas -->
<div id="successAlert" class="alert success" style="display:none;">
  <div class="alert-icon">✓</div>
  <span id="successMessageAlert">Documento borrado con éxito.</span>
</div>

<div id="errorAlert" class="alert error" style="display:none;">
  <div class="alert-icon">✕</div>
  <span id="errorMessageAlert">No se pudo eliminar el documento.</span>
</div>

{% endblock principal %}

{% block js %}
  <script src="{% static 'staffweb/js/administrar_documentos.js' %}"></script>
{% endblock js %}

